<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalidade - CRONO LOGIAS</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ... (Existing CSS styles - keep them) ... */
        .personalidade-container {
            display: flex;
            gap: 40px;
            padding: 20px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            box-sizing: border-box;
            flex-wrap: wrap;
        }
        .personalidade-info {
            flex: 1;
            max-width: 400px;
        }
        .personalidade-image {
            width: 100%;
            max-width: 400px;
            height: auto;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .personalidade-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .personalidade-description {
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .personalidade-date-range {
            color: #666;
            margin-bottom: 15px;
        }
        .contemporaneos-panel {
            background-color: #f8f8f8;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            border: 1px solid #eee;
            transition: all 0.3s ease;
        }
        .contemporaneos-autocomplete-input {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background-color: #f8f8f8;
            transition: all 0.3s ease;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .contemporaneos-autocomplete-input:focus {
            outline: none;
            border-color: #2196F3;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .contemporaneos-autocomplete-input::placeholder {
            color: #9e9e9e;
            font-weight: 400;
        }

        .autocomplete-list {
            margin-top: 5px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .autocomplete-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: #333;
        }

        .autocomplete-item:hover {
            background-color: #f0f7ff;
        }
        .contemporaneos-list {
            display: block;
            margin-top: 25px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .contemporaneos-list.active {
            display: block;
            max-height: 800px;
            opacity: 1;
        }
        .contemporaneo-item {
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            margin-bottom: 15px;
            background-color: white;
            transition: all 0.3s ease;
            display: block;
            text-decoration: none;
            color: inherit;
        }
        .contemporaneo-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            border-color: #ddd;
        }
        .contemporaneo-name {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.1em;
            color: #333;
        }
        .contemporaneo-description {
            font-style: italic;
            font-size: 0.9em;
            color: #666;
            margin: 4px 0;
        }

        .contemporaneo-dates {
            font-size: 0.95em;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contemporaneos-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            width: 100%;
            text-align: center;
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
        }
        .contemporaneos-button:hover {
            background-color: #444;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .contemporaneos-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .contemporaneos-list {
            margin-top: 25px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .contemporaneos-list.active {
            display: block;
            max-height: 800px;
            opacity: 1;
        }
        .evento-timeline {
            flex: 2;
            position: relative;
            padding-left: 50px;
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            min-width: 300px;
        }
        .evento-timeline::before {
            content: '';
            position: absolute;
            left: 19px;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ddd;
        }
        .evento-item {
            padding: 20px;
            margin-bottom: 30px;
            position: relative;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            box-sizing: border-box;
            display: block;
            clear: both;
        }
        .evento-item::before {
            content: '';
            position: absolute;
            left: -50px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #333;
            border: 2px solid white;
        }
        .timeline-section {
            width: 100%;
            padding: 40px 20px 200px 20px;
            margin-top: 120px; /* Increased from 80px to 120px for more spacing */
            background-color: #f8f8f8;
            border-radius: 12px;
        }
        .timeline-container {
            position: relative;
            width: 100%;
            height: 4px;
            background-color: #ddd;
            margin: 160px 0; /* Increased from 40px to 60px for better spacing */
            padding: 0 20px;
        }
        .timeline-line {
            position: absolute;
            top: 0;
            left: 20px;
            right: 20px;
            height: 100%;
            background-color: #333;
        }
        .timeline-year {
            position: absolute;
            top: -30px;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        .timeline-year.start {
            left: 20px;
        }
        .timeline-year.end {
            right: 20px;
            transform: translateX(50%);
        }
        .timeline-dot {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background-color: #333;
            border-radius: 50%;
            cursor: pointer;
        }
        .timeline-dot.start {
            left: 20px;
        }
        .timeline-dot.end {
            right: 20px;
        }
        .timeline-event {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background-color: #666;
            border-radius: 50%;
            cursor: pointer;
        }
        .timeline-event::before {
            content: '';
            position: absolute;
            top: 50%; /* Changed to top: 50% for lines upwards */
            left: 50%;
            width: 1px;
            height: 75px; /* Altura da linha tracejada mantida */
            border-left: 1px dashed #666;
            z-index: 0;
        }
        .timeline-event-label {
            position: absolute; /* Importante para o JS manipular a posição */
            top: calc(50% - 75px); /* Changed to top: calc(50% - 75px) - Initial position above */
            left: 50%;
            transform: translateX(-50%);
            font-size: 14px;
            color: #666;
            text-align: center;
            white-space: normal;
            word-wrap: break-word;
            max-width: 150px;
            z-index: 2; /* Garante que os labels fiquem acima da linha */
            line-height: 1.2em;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .timeline-event-label > * {
            margin: 2px 0;
        }
        .timeline-event:nth-child(even) .timeline-event-label {
            bottom: auto; /* Remove bottom para o JS controlar */
            top: auto;    /* Remove top para o JS controlar */
        }
        .timeline-event:nth-child(even)::before {
            bottom: auto;
            top: 50%;
            height: 75px;
        }
        .timeline-event:hover {
            background-color: #333;
        }
        .timeline-event:hover::before {
            border-left-color: #333;
        }
        .timeline-event:hover + .timeline-event-label {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
                <a href="index.html">CRONO LOGIAS</a>
            </div>
            <nav class="nav-menu">
                <a href="neste-dia.html" class="nav-item">NESTE DIA</a>
                <a href="top-mundial.html" class="nav-item">TOP MUNDIAL</a>
                <a href="por-tema.html" class="nav-item">POR TEMA</a>
                <a href="por-ano.html" class="nav-item">POR ANO</a>
                <a href="personalidades.html" class="nav-item">PERSONALIDADES</a>
                <a href="a-linha.html" class="nav-item">A LINHA</a>
                <a href="criar.html" class="nav-item">CRIAR</a>
            </nav>
        </div>
        <main class="main-content">
            <div id="personalidade-content">
                <div class="loading">Carregando...</div>
            </div>
        </main>
    </div>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, query, limitToLast, orderByChild } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "cronologias-ce797.firebaseapp.com",
            databaseURL: "https://cronologias-ce797-default-rtdb.firebaseio.com",
            projectId: "cronologias-ce797",
            storageBucket: "cronologias-ce797.firebasestorage.app",
            messagingSenderId: "417864483809",
            appId: "1:417864483809:web:c06cc69fec7891cb7588a0",
            measurementId: "G-XQG7DE12YS"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Get personality ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const personalidadeId = urlParams.get('id');


        let todosOficios = {};
        let todasPersonalidadesCache = {};
        let todosEventosCache = {};

        // --- Helper functions (parseHistoricalDate, datesOverlap, rectIntersect) ---
        function parseHistoricalDate(dateStr) { /* ... (parseHistoricalDate function from previous versions) ... */ }
        function datesOverlap(start1, end1, start2, end2) { /* ... (datesOverlap function from previous versions) ... */ }
        function rectIntersect(rect1, rect2) { /* ... (rectIntersect function from previous versions) ... */ }


        // --- Autocomplete Functions ---
        function setupAutocomplete(inputElementId, listElementId, data, valueField = 'id', textField = 'nome', recentItemsProvider) { /* ... (setupAutocomplete function from previous versions) ... */ }
        async function popularOficiosAutocomplete() { /* ... (popularOficiosAutocomplete function from previous versions) ... */ }


        // --- Timeline Label Adjustment Function ---
        function adjustTimelineLabels() { /* ... (adjustTimelineLabels function from previous versions - Version 8) ... */ }


        if (!personalidadeId) {
            document.getElementById('personalidade-content').innerHTML =
                '<div class="error">Personalidade não encontrada</div>';
        } else {
            // Fetch personality data and events
            const personalidadeRef = ref(database, `personalidades/${personalidadeId}`);
            const eventosRef = ref(database, `eventos`);
            const todasPersonalidadesRef = ref(database, 'personalidades');
            const todosEventosRef = ref(database, 'eventos');
            const oficiosRef = ref(database, 'oficios');


            Promise.all([
                get(personalidadeRef),
                get(eventosRef),
                get(todasPersonalidadesRef),
                get(todosEventosRef),
                get(oficiosRef)
            ]).then(([personalidadeSnapshot, eventosSnapshot, todasPersonalidadesSnapshot, todosEventosSnapshot, oficiosSnapshot]) => {
                if (personalidadeSnapshot.exists()) {
                    const personalidade = personalidadeSnapshot.val();
                    const todosEventos = eventosSnapshot.val() || {};
                    todasPersonalidadesCache = todasPersonalidadesSnapshot.val() || {};
                    todosEventosCache = todosEventosSnapshot.val() || {};
                    todosOficios = oficiosSnapshot.val() || {};


                    const eventosPersonalidade = Object.entries(todosEventos)
                        .filter(([_, evento]) => evento.itemId === personalidadeId)
                        .map(([id, evento]) => ({
                            id,
                            date: evento.date || '',
                            name: evento.name || ''
                        }));

                    const eventosArray = eventosPersonalidade
                        .filter(evento => evento.date && evento.name)
                        .sort((a, b) => {
                            const dateA = new Date(a.date);
                            const dateB = new Date(b.date);
                            return dateA - dateB;
                        });

                    const birthEvent = eventosPersonalidade.find(evento => evento.name === 'Nascimento');
                    const deathEvent = eventosPersonalidade.find(evento => evento.name === 'Falecimento');

                    const dateRange = birthEvent ?
                        `${birthEvent.date} - ${deathEvent ? deathEvent.date : 'Presente'}` :
                        'Sem eventos';

                    const content = `
                        <div class="personalidade-container">
                            <div class="personalidade-info">
                                <img src="${personalidade.imageUrl || ''}" alt="${personalidade.name || 'Personalidade'}" class="personalidade-image">
                                <div class="personalidade-name">${personalidade.name || 'Nome não disponível'}</div>
                                <div class="personalidade-description">${personalidade.description || 'Descrição não disponível'}</div>
                                <div class="personalidade-date-range">${dateRange}</div>
                                <div class="contemporaneos-panel">
                                    <div id="filtros-contemporaneos" style="display: none; flex-direction: column; align-items: stretch; gap: 10px;">
                                        <div class="autocomplete-container">
                                            <input type="text" id="oficio-autocomplete" class="contemporaneos-autocomplete-input" placeholder="Filtrar por Ofício">
                                            <div id="oficio-autocomplete-list" class="autocomplete-list"></div>
                                        </div>
                                    </div>
                                    <div class="button-group" style="display: flex; gap: 10px;">
                                        <a href="#" class="contemporaneos-button">Contemporâneos</a>
                                        <a href="#" class="contemporaneos-button" id="timeline-button">Timeline</a>
                                    </div>
                                    <div class="contemporaneos-list" id="contemporaneosList"></div>
                                </div>
                            </div>
                            <div class="eventos-timeline">
                                ${eventosArray.map(evento => `
                                    <div class="evento-item">
                                        <div class="evento-date">${evento.date}</div>
                                        <div class="evento-name">${evento.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div class="timeline-section">
                            <h2 style="margin-bottom: 20px;">Linha do Tempo</h2>
                            <div class="timeline-container">
                                <div class="timeline-line"></div>
                                <div class="timeline-dot start"></div>
                                <div class="timeline-dot end"></div>
                                <div class="timeline-year start">${birthEvent ? birthEvent.date.split('-').pop() : 'N/A'}</div>
                                <div class="timeline-year end">${deathEvent ? deathEvent.date.split('-').pop() : 'Presente'}</div>
                                ${eventosArray.map((evento, index) => {
                                    const eventDateParts = evento.date.split('-');
                                    const isAC = evento.date.includes('--');
                                    let yearString = eventDateParts[eventDateParts.length - 1];
                                    if (isAC) {
                                        yearString = yearString.replace('--', '');
                                    }
                                    const eventYear = parseInt(yearString, 10) * (isAC ? -1 : 1);

                                    const birthDateParts = birthEvent.date.split('-');
                                    const birthIsAC = birthEvent.date.includes('--');
                                    let birthYearString = birthDateParts[birthDateParts.length - 1];
                                    if (birthIsAC) {
                                        birthYearString = birthYearString.replace('--', '');
                                    }
                                    const birthYear = parseInt(birthYearString, 10) * (birthIsAC ? -1 : 1);

                                    let deathYear = null;
                                    if (deathEvent) {
                                        const deathDateParts = deathEvent.date.split('-');
                                        const deathIsAC = deathEvent.date.includes('--');
                                        let deathYearString = deathDateParts[deathDateParts.length - 1];
                                        if (deathIsAC) {
                                            deathYearString = deathYearString.replace('--', '');
                                        }
                                        deathYear = parseInt(deathYearString, 10) * (deathIsAC ? -1 : 1);
                                    } else {
                                        deathYear = new Date().getFullYear();
                                    }

                                    if (birthYear && eventYear && deathYear) {
                                        const timeRange = deathYear - birthYear;
                                        const eventPosition = ((eventYear - birthYear) / timeRange) * 100;
                                        return `
                                            <div class="timeline-event" style="left: ${20 + (eventPosition * 0.6)}%"></div>
                                            <div class="timeline-event-label" style="left: ${20 + (eventPosition * 0.6)}%">
                                                <div>${evento.date}</div>
                                                <div>${evento.name}</div>
                                            </div>
                                        `;
                                    }
                                    return '';
                                }).join('')}
                            </div>
                        </div>
                    `;

                    document.getElementById('personalidade-content').innerHTML = content;

                    // Add event listener for timeline button
                    document.getElementById('timeline-button').addEventListener('click', function(e) {
                        e.preventDefault();
                        const timelineSection = document.querySelector('.timeline-section');
                        timelineSection.scrollIntoView({ behavior: 'smooth' });
                    });

                    adjustTimelineLabels(); // Call label adjustment function after content is set


                    const oficioAutocompleteInput = document.getElementById('oficio-autocomplete');
                    const oficioAutocompleteList = document.getElementById('oficio-autocomplete-list');
                    const contemporaneosList = document.getElementById('contemporaneosList');
                    const contemporaneosButton = document.querySelector('.contemporaneos-button');
                    const filtrosContainer = document.getElementById('filtros-contemporaneos');

                    popularOficiosAutocomplete().then(recentOficios => {
                        setupAutocomplete(
                            'oficio-autocomplete',
                            'oficio-autocomplete-list',
                            todosOficios,
                            'id',
                            'nome',
                            popularOficiosAutocomplete
                        );
                    });


                    contemporaneosButton.addEventListener('click', async (e) => {
                        e.preventDefault();
                        contemporaneosList.classList.toggle('active');

                        if (contemporaneosList.classList.contains('active')) {
                            filtrosContainer.style.display = 'flex';
                            contemporaneosList.innerHTML = '<div class="loading">Carregando contemporâneos...</div>';


                            const todasPersonalidades = todasPersonalidadesCache;
                            const todosEventos = todosEventosCache;


                            const currentPersonEvents = Object.values(todosEventos)
                                .filter(evento => evento.itemId === personalidadeId);

                            const currentBirthEvent = currentPersonEvents
                                .find(evento => evento.name === 'Nascimento');
                            const currentDeathEvent = currentPersonEvents
                                .find(evento => evento.name === 'Falecimento');

                            const currentBirthDate = currentBirthEvent ? parseHistoricalDate(currentBirthEvent.date) : null;
                            const currentDeathDate = currentDeathEvent ? parseHistoricalDate(currentDeathEvent.date) : new Date();


                            const oficioFiltrarId = oficioAutocompleteInput.dataset.selectedId;

                            let contemporaneos = [];

                            for (const [id, pessoa] of Object.entries(todasPersonalidades)) {
                                if (id === personalidadeId) continue;

                                let oficioCorresponde = true;
                                if (oficioFiltrarId && oficioFiltrarId !== "") {
                                    const pessoaOficioId = pessoa.oficioId;
                                    oficioCorresponde = pessoaOficioId === oficioFiltrarId;
                                }
                                if (!oficioCorresponde) continue;

                                const pessoaEvents = Object.values(todosEventos)
                                    .filter(evento => evento.itemId === id);

                                const birthEvent = pessoaEvents
                                    .find(evento => evento.name === 'Nascimento');
                                const deathEvent = pessoaEvents
                                    .find(evento => evento.name === 'Falecimento');

                                if (!birthEvent) continue;

                                const birthDate = parseHistoricalDate(birthEvent.date);
                                const deathDate = deathEvent ? parseHistoricalDate(deathEvent.date) : new Date();

                                const overlap = datesOverlap(currentBirthDate, currentDeathDate, birthDate, deathDate);

                                if (overlap) {
                                    contemporaneos.push({
                                        id,
                                        name: pessoa.name,
                                        description: pessoa.description,
                                        birthDate: birthEvent.date,
                                        deathDate: deathEvent ? deathEvent.date : 'Presente'
                                    });
                                }
                            }

                            contemporaneos.sort((a, b) => {
                                const dateA = parseHistoricalDate(a.birthDate);
                                const dateB = parseHistoricalDate(b.birthDate);
                                return dateA.getTime() - dateB.getTime();
                            });

                            const isFilterActive = oficioAutocompleteInput.dataset.selectedId;
                            let contemporaneosToShow = contemporaneos;

                            if (!isFilterActive) {
                                contemporaneosToShow = contemporaneos.slice(0, 10);
                            }


                            contemporaneosList.innerHTML = contemporaneosToShow
                                .map(pessoa => `
                                    <a href="personalidade.html?id=${pessoa.id}" class="contemporaneo-item">
                                        <div class="contemporaneo-name">${pessoa.name}</div>
                                        <div class="contemporaneo-description">${pessoa.description || 'Sem descrição disponível'}</div>
                                        <div class="contemporaneo-dates">${pessoa.birthDate} - ${pessoa.deathDate}</div>
                                    </a>
                                `)
                                .join('') || '<div class="error">Nenhum contemporâneo encontrado</div>';
                        } else {
                            filtrosContainer.style.display = 'none';
                            contemporaneosList.innerHTML = '';
                        }
                    });


                } else {
                    document.getElementById('personalidade-content').innerHTML =
                        '<div class="error">Personalidade não encontrada</div>';
                }
            }).catch((error) => {
                console.error(error);
                document.getElementById('personalidade-content').innerHTML =
                    '<div class="error">Erro ao carregar dados</div>';
            });
        }


    </script>
</body>
</html>
